Data Package Message

应用层——消息
传输层——数据段(segment)
网络层——分组、数据包（packet）
链路层——帧（frame）
物理层——P-PDU（bit）


- TCP报文(TCP -> L3)

    +----------------------------------------------------------+
    |       SrcPort(16bit)       |        DstPort(16bit)       |
    +----------------------------------------------------------+
    |                    Sequence Number(4byte)                |
    +----------------------------------------------------------+
    |                 Acknowledgment Number(4byte)             |
    +----------------------------------------------------------+
    | Data Offset(4bit)|

- ICMP报文(ICMP -> L2)

    +----------------------------------------------------------+
    | Type(1byte)  |  Code(1byte) |      Checksum(2byte)       |
    +----------------------------------------------------------+
    |                      Options(0~4byte)                    |
    +----------------------------------------------------------+
    |                           Data                           |
    +----------------------------------------------------------+

-- 差错报文

    +-----------------------------------------------------------------------+
    | ICMP Pre(8byte) | IP Header(20~60byte) + Options | IP Data Pre(8byte) |
    +-----------------------------------------------------------------------+

-- 报文内容类型

    +-----------------------------------------------------------+
    |    种类   |  类型 |    描述                               |
    +-----------|-------|---------------------------------------+
    | 差错报文: |   3   |  目的端不可达                         |
    |           |   4   |  源点抑制                             |
    |           |   11  |  超时                                 |
    |           |   12  |  参数问题                             |
    |           |   5   |  改变路由                             |
    +-----------|-------|---------------------------------------+
    | 查询报文: |  8/0  | 回显请求或应答                        |
    |           | 13/14 | 时间戳请求或应答                      |
    |           | 17/18 | 地址掩码请求或应答                    |
    |           | 10/9  | 路由询问和通告                        |
    +-----------------------------------------------------------+


- ARP报文(ARP -> L2)

    +----------------------------------------------------------------------------------------------------------------------------------------------------------+
    | Hard Type(2byte)| Protocol Type(2byte) | Hard Len(1byte) | Protocol Len(1byte) | Op(2byte) | SrcMac(6byte) | SrcIp(4byte) | DstMac(6byte) | DstIp(4byte) |
    +----------------------------------------------------------------------------------------------------------------------------------------------------------+

    +------------------------------------------------------------------------------------------+
    |Hard Type(硬件类型):        | 表示硬件地址的类型.它的值为1表示以太网地址.               |
    +----------------------------|-------------------------------------------------------------+
    |Protocol Type(协议类型):    | 表示要映射的协议地址类型.它的值为0x0800即表示IP地址.      |
    +----------------------------|-------------------------------------------------------------+
    |Hard Len(硬件地址长度):     | 硬件地址长度.                                              |
    +----------------------------|-------------------------------------------------------------+
    |Protocol Len(协议地址长度): | 协议地址长度                                                |
    +----------------------------|-------------------------------------------------------------+
    |Op(操作类型):               | 1:ARP REQUEST 2:ARP RESPONSE 3:RARP REQUEST 4:RARP RESPONSE |
    +----------------------------|-------------------------------------------------------------+
    |SrcMac(源MAC):              | 源MAC地址                                                   |
    +----------------------------|-------------------------------------------------------------+
    |SrcIp(源IP):                | 源IP地址                                                    |
    +----------------------------|-------------------------------------------------------------+
    |DstMac(目的MAC):            | 目的MAC地址                                                 |
    +----------------------------|-------------------------------------------------------------+
    |DstIp(目的IP):              | 目的IP地址                                                  |
    +------------------------------------------------------------------------------------------+


- L3报文(IP -> L2)

    +-----------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------
    | Offsets |	Octet |              0                |                  1                  |                  2                    |                  3                    |     |           |
    +---------|-------|-------------------------------|-------------------------------------|---------------------------------------|---------------------------------------+     |           |
    |  Octet  |  Bit  | 0 | 1 | 2 | 3 | 4 | 5 | 6 | 7 | 8 | 9 | 10 | 11 | 12 | 13 | 14 | 15 | 16 | 17 | 18 | 19 | 20 | 21 | 22 | 23 | 24 | 25 | 26 | 27 | 28 | 29 | 30 | 31 |     |           |
    +---------|-------|-----------------------------------------------------------------------------------------------------------------------------------------------------+     |           |
    |    0	  |  0	  |     Version	  |      IHL      |	           DSCP	          |   ECN   |	                          Total Length                                      |     |           |
    +---------|-------|-----------------------------------------------------------------------------------------------------------------------------------------------------+     |           |
    |    4	  |  32	  |                         Identification	                            |      Flags   |	                      Fragment Offset                       |    header       |
    +---------|-------|-----------------------------------------------------------------------------------------------------------------------------------------------------+ (20~60byte)     |
    |    8	  |  64	  |          Time To Live	      |                Protocol	            |                             Header Checksum                                   |     |       46~65535byte
    +---------|-------|-----------------------------------------------------------------------------------------------------------------------------------------------------+     |           |
    |    12	  |  96	  |                                                              Source IP Address                                                                      |     |           |
    +---------|-------|-----------------------------------------------------------------------------------------------------------------------------------------------------+     |           |
    |    16	  |  128  |                                                            Destination IP Address                                                                   |     |           |
    +---------|-------|-----------------------------------------------------------------------------------------------------------------------------------------------------+     |           |
    |   ....  |  .... |	                                                           Options + Padding(0~44byte)                                                              |     |           |
    +---------|-------|-----------------------------------------------------------------------------------------------------------------------------------------------------+-------          |
    |   ....  |  .... |                                                                    Data                                                                             |                 |
    +-----------------------------------------------------------------------------------------------------------------------------------------------------------------------+---------------------
    
    +---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    |Version(版本)        | 指IP协议的版本.通信双方使用的IP协议版本必须一致.目前广泛使用的IP协议版本号为4（即IPv4）.关于IPv6,目前还处于草案阶段.                                                              |
    +---------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    |Header Len(首部长度) | 可表示的最大十进制数值是15.请注意,这个字段所表示数的单位是32位字长（1个32位字长是4字节）,因此,当IP的首部长度为1111时（即十进制的15）,首部长度就达到60字节.                        |
    |                     | 当IP分组的首部长度不是4字节的整数倍时,必须利用最后的填充字段加以填充.因此数据部分永远在4字节的整数倍开始,这样在实现IP协议时较为方便.                                              |
    |                     | 首部长度限制为60字节的缺点是有时可能不够用.但这样做是希望用户尽量减少开销.最常用的首部长度就是20字节（即首部长度为0101）,这时不使用任何选项.                                      |
    +---------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    |DSCP(区分服务)       | 前三位表示优先级(000-111),数值越大优先级越高;后三位表示为时延吞吐量可靠性(DTR), (D)时延 -> 0:普通 1:延迟尽量小 (T)吞吐量 -> 0:普通 1:流量尽量大 (R)可靠性 -> 0:普通 1:可靠性尽量大|
    +---------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    |ECN(显式拥塞通告)    | 00:走原有普通非ECN流程,即过载丢包 01/10:拥塞发生时需要修改为ECN=11,并继续转发流程.                                                                                                |
    +---------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    |Total Len(总长度)    | 总长度指首部和数据之和的长度,单位为字节.总长度字段为16位,因此数据报的最大长度为2^16-1=65535字节.                                                                                  |
    |                     | 在IP层下面的每一种数据链路层都有自己的帧格式,其中包括帧格式中的数据字段的最大长度,这称为最大传送单元MTU(Maximum Transfer Unit).                                                   |
    |                     | 当一个数据报封装成链路层的帧时,此数据报的总长度（即首部加上数据部分）一定不能超过下面的数据链路层的MTU值.                                                                         |
    +---------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    |Iden(标识)           | IP软件在存储器中维持一个计数器,每产生一个数据报,计数器就加1,并将此值赋给标识字段.                                                                                                 |
    |                     | 但这个"标识"并不是序号,因为IP是无连接服务,数据报不存在按序接收的问题.当数据报由于长度超过网络的MTU而必须分片时,这个标识字段的值就被复制到所有的数据报的标识字段中.                |
    |                     | 相同的标识字段的值使分片后的各数据报片最后能正确地重装成为原来的数据报.                                                                                                           |
    +---------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    |Flag(标志)           | 但目前只有2位有意义.                                                                                                                                                              |
    |                     | 标志字段中的最低位记为MF(More Fragment).MF=1即表示后面"还有分片"的数据报.MF=0表示这已是若干数据报片中的最后一个.                                                                  |
    |                     | 标志字段中间的一位记为DF(Don’t Fragment),意思是"不能分片".只有当DF=0时才允许分片.                                                                                                |
    +---------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    |Fgmt Offset(片偏移)  | 片偏移指出：较长的分组在分片后,某片在原分组中的相对位置.也就是说,相对用户数据字段的起点,该片从何处开始.片偏移以8个字节为偏移单位.                                                 |
    |                     | 这就是说,除了最后一个分片,每个分片的长度一定是8字节（64位）的整数倍.                                                                                                              |
    +---------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    |TTL(生存时间)        | 生存时间字段常用的的英文缩写是TTL(Time To Live),表明是数据报在网络中的寿命.由发出数据报的源点设置这个字段.                                                                        |
    |                     | 其目的是防止无法交付的数据报无限制地在因特网中兜圈子,因而白白消耗网络资源.最初的设计是以秒作为TTL的单位.每经过一个路由器时,就把TTL减去数据报在路由器消耗掉的一段时间.             |
    |                     | 若数据报在路由器消耗的时间小于1秒,就把TTL值减1.当TTL值为0时,就丢弃这个数据报.后来把TTL字段的功能改为"跳数限制"（但名称不变）.                                                     |
    |                     | 路由器在转发数据报之前就把TTL值减1.若TTL值减少到零,就丢弃这个数据报,不再转发.因此,现在TTL的单位不再是秒,而是跳数.                                                                 |
    |                     | TTL的意义是指明数据报在网络中至多可经过多少个路由器.显然,数据报在网络上经过的路由器的最大数值是255.若把TTL的初始值设为1,就表示这个数据报只能在本局域网中传送.                     |
    +---------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    |Protocol(协议)       | 协议字段指出此数据报携带的数据是使用何种协议,以便使目的主机的IP层知道应将数据部分上交给哪个处理过程.(1:ICMP, 2:IGMP, 6:TCP, 17:UDP, 41:ENCAP, 89:OSPF, 132:SCTP)                  |
    +---------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    |Header Checksum      | 这个字段只检验数据报的首部,但不包括数据部分.这是因为数据报每经过一个路由器,路由器都要重新计算一下首部检验和（一些字段,如生存时间、标志、片偏移等都可能发生变化）.                 |
    |(首部检验和)  　     | 不检验数据部分可减少计算的工作量.                                                                                                                                                 |
    +---------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    |SrcIP(源IP地址)      | 源IP地址(二进制)                                                                                                                                                                  |
    +---------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
    |DstIp(目的IP地址)    | 目的IP地址(二进制)                                                                                                                                                                |
    +---------------------+-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
    |
    +---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+



- L2报文

    |-----------------------最小60字节-----------------------|
    +---------------------------------------------------------------+
    | dst mac | src mac | type |            data             |  crc |
    +---------------------------------------------------------------+
    |  6byte  |  6byte  | 2byte|         46~1500byte         | 4byte|
    +---------------------------------------------------------------+
                        | 0800 |        IP DATA PKG          |
                        | 0806 |     ARP REQUEST/RESPONSE    |
                        | 8035 |    RARP REQUEST/RESPONSE    |


